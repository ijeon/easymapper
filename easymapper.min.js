/*Easy_Mapper_v20180220_inpyodev@gmail.com_GPLv3_https://github.com/inpyodev/easymapper*/var imgWidth,imgHeight,filepath,x,y,start,end,popup,shortcut,theme,language,unit="%",measure="drag",isIE=!!document.documentMode,phase=0,editing=!1,mapEl=[],clipboard=[],isImport=!1,isPaste=!1,langPreview=!1;function setup(){loadOptions(),langSelect(),clearWorkspace(),imgWidth=$("#img").width(),imgHeight=$("#img").height(),$(".ruler.x").css({width:imgWidth}),$(".ruler.y").css({height:imgHeight}),$("#navbar").css({maxWidth:imgWidth+20}),drawRuler()}function clearWorkspace(){return $("#maps").empty(),mapEl=[],tagScript="",mapScript="",closeLightbox(),!1}function drawRuler(){if($(".ruler").empty(),$("#btn-toggle-unit").text(unit),"%"==unit){$(".ruler").removeClass("px").addClass("perc");for(var e=0;e<21;e++)e%2==0?$(".ruler").append('<li class="long"><span>'+5*e+"%</span></li>"):$(".ruler").append("<li></li>")}else{$(".ruler").removeClass("perc").addClass("px");for(e=0;e<imgWidth/10+1;e++)e%10==0?$(".ruler.x").append('<li class="long"><span>'+10*e+"px</span></li>"):$(".ruler.x").append("<li></li>");for(e=0;e<imgHeight/10+1;e++)e%10==0?$(".ruler.y").append('<li class="long"><span>'+10*e+"px</span></li>"):$(".ruler.y").append("<li></li>")}}function loadImage(){var e=$(this).parents("#lightbox").hasClass("url")?$("#input-img-url").val():filepath;return $("#img").attr("src",e).on("load",setup),closeLightbox(),!1}function parsePath(e){var t=window.webkitURL||window.URL;filepath=t.createObjectURL(e.target.files[0]),$("#label-img-local > p").text("File loaded"),$("#label-img-local").addClass("active")}function importCode(){$("#imported").html($("#input-code").val());var e=$("#imported").find("img").attr("src");return $("#img").attr("src",e).on("load",importSetup),!1}function importSetup(){var e=$("#imported").find("a").length>0,t=e?$("#imported").find("a"):$("#imported").find("area");setup(),isImport=!0;for(var a=0;a<t.length;a++){var i=t.eq(a),s=[];s[0]=e?parseInt(i.css("left")):i.attr("coords").split(",")[0],s[1]=e?parseInt(i.css("top")):i.attr("coords").split(",")[1],s[2]=e?parseInt(i.css("left"))+parseInt(i.css("width")):i.attr("coords").split(",")[2],s[3]=e?parseInt(i.css("top"))+parseInt(i.css("height")):i.attr("coords").split(",")[3];var n=i.attr("href"),o=i.attr("target");createMap({x:s[0],y:s[1]},{x:s[2],y:s[3]}),n.indexOf("//")>0&&(mapEl[a][4]=n,$(".map").eq(a).addClass("linked")),mapEl[a][5]=o}isImport=!1}function moveGrid(e){x=e.pageX-20,y=e.pageY-54,setGrid(),setCoords()}function toggleGrid(e){"mouseenter"==e.type&&$(".ui-draggable-dragging").length+$(".ui-resizable-resizing").length==0?$(this).addClass("active"):($(this).removeClass("active"),resetGrid())}function setGrid(){$(".axis.x.active").css({left:x}),$(".axis.y.active").css({top:y})}function setCoords(){var e=(x/imgWidth*100).toFixed(2),t=(y/imgWidth*100).toFixed(2),a="%"==unit?e+"%, "+t+"%":x+"px, "+y+"px";$("#coords").css({left:x+1,top:y+1}).text(a),x+$("#coords").outerWidth()>imgWidth&&$("#coords").css({left:x-$("#coords").outerWidth()}),y+$("#coords").outerHeight()>imgHeight&&$("#coords").css({top:y-$("#coords").outerHeight()})}function resetGrid(){return $(".axis.a").addClass("active"),phase=0,setGrid(),!1}function drawMap(e){return 0==phase?("drag"==measure&&"mousedown"==e.type||"click"==measure&&"click"==e.type)&&($(".map").removeClass("selected"),start={x:x,y:y},$(".axis.a").removeClass("active"),phase=1):1==phase&&("drag"==measure&&"mouseup"==e.type||"click"==measure&&"click"==e.type)&&(Math.abs(start.x-x)>10&&Math.abs(start.y-y)>10?(end={x:x,y:y},$(".axis.a").addClass("active"),phase=0,createMap(start,end)):resetGrid()),!1}function createMap(e,t){var a=mapEl.length,i=Math.abs(e.x-t.x)-1,s=Math.abs(e.y-t.y)-1,n=Math.min(e.y,t.y),o=Math.min(e.x,t.x),l='<li id="map_'+a+'" class="map unlinked" style="top:'+n+"px; left:"+o+"px; width:"+i+"px; height:"+s+'px"><span class="mapid">'+parseInt(a+1)+'</span><a class="btn-map-remove btn-lb-open" data-json="remove" href="#">Ã—</a><a class="btn-map-resize" href="#">â¤¡</a><a class="btn-map-link btn-lb-open" data-json="link" href="#">ðŸ”—</a></li>';$("#maps").append(l),$(".map").removeClass("selected"),$("#map_"+a).addClass("selected").draggable({containment:"#canvas"}).resizable({containment:"#canvas",minWidth:20,minHeight:20}),mapEl.push([n,o,i,s,"","_self"]),mapEl[a][2]<40||mapEl[a][3]<30?$(".map.selected").addClass("small"):$(".map.selected").removeClass("small"),!popup||isImport||isPaste||openLightbox("link")}function editMap(){var e=parseInt($(".map.selected").css("top")),t=parseInt($(".map.selected").css("left")),a=parseInt($(".map.selected").css("width")),i=parseInt($(".map.selected").css("height"));mapEl[getMapId()][0]=e,mapEl[getMapId()][1]=t,mapEl[getMapId()][2]=a,mapEl[getMapId()][3]=i,mapEl[getMapId()][2]<40||mapEl[getMapId()][3]<30?$(".map.selected").addClass("small"):$(".map.selected").removeClass("small")}function removeMap(){for(mapEl.splice(getMapId(),1),$(".map.selected").remove(),i=0;i<mapEl.length;i++)$(".map").eq(i).attr("id","map_"+i),$(".map").eq(i).find(".mapid").text(i+1);return closeLightbox(),!1}function selectMap(){$(".map").removeClass("selected"),$(this).addClass("selected")}function linkMap(){var e=$("#input-link-url").val(),t=$('input[name="radio-link"]:checked').val();return e.indexOf("//")>0?0==e.split("//")[1].length?$("#err-link").addClass("active"):(e.split("//")[2]&&(e=e.substring(e.indexOf("//")+2)),mapEl[getMapId()][4]=e,mapEl[getMapId()][5]=t,$(".map.selected").addClass("linked"),closeLightbox()):$("#err-link").addClass("active"),!1}function loadMap(){var e=mapEl[getMapId()][4],t=mapEl[getMapId()][5];e.length>0&&$("#input-link-url").val(e),$('input[name="radio-link"][value='+t+"]").prop("checked",!0)}function getMapId(){return $(".map.selected").find(".mapid").text()-1}function duplicateMap(e){if("copy"==e)clipboard=mapEl[getMapId()];else if(clipboard.length>0){var t={x:clipboard[1],y:clipboard[0]},a={x:clipboard[1]+clipboard[2]+1,y:clipboard[0]+clipboard[3]+1};isPaste=!0,createMap(t,a),isPaste=!1}}function generateCode(){var e=$("#img").attr("src").indexOf("http")>-1?$("#img").attr("src"):"#ERR",t="",a="",s=(+new Date).toString(36);for(i=0;i<mapEl.length;i++){var n=mapEl[i][4].length>0?mapEl[i][4]:"#ERR",o=mapEl[i][5];t+='<a href="'+n+'" style="position:absolute;top:'+(mapEl[i][0]/imgHeight*100).toFixed(2)+"%;left:"+(mapEl[i][1]/imgWidth*100).toFixed(2)+"%;width:"+(mapEl[i][2]/imgWidth*100).toFixed(2)+"%;height:"+(mapEl[i][3]/imgHeight*100).toFixed(2)+'%;background:url(about:blank);display:block;" target="'+o+'"></a>',a+='<area shape="rect" coords="'+mapEl[i][1]+","+mapEl[i][0]+","+(mapEl[i][1]+mapEl[i][2])+","+(mapEl[i][0]+mapEl[i][3])+'" href="'+n+'" target="'+o+'">'}var l='<div style="position:relative;font-size:0;padding:0;max-width:'+imgWidth+"px;max-height:"+imgHeight+'px;"><img src="'+e+'" style="width:100%;">'+t+"</div>",p='<img src="'+e+'" usemap="#'+s+'"><map name="'+s+'">'+a+"</map>";$("#code-tag").text(l),$("#code-map").text(p),$("#lb-content textarea").val().indexOf("#ERR")>-1&&($(".errors").addClass("active"),$("#lb-content textarea").addClass("err"))}function copyCode(){return $("#lightbox").find("textarea").select(),document.execCommand("Copy"),!1}function openLightbox(e){"object"==typeof e&&(e=$(this).data("json"));var t=window[language+"_"+e+"Json"],a='<div id="lb-title"><p>'+t.title+'</p><a class="btn-lb-close" href="#">Ã—</a></div><div id="lb-content">'+t.content+'</div><div id="lb-btnset" class="'+t.btnSet+'"><a id="btn-lb-no" class="'+t.btnNoClass+'" data-json="'+t.btnNoJson+'" href="#">'+t.btnNo+'</a><a id="btn-lb-yes" class="'+t.btnYesClass+'" data-json="'+t.btnYesJson+'" href="#">'+t.btnYes+"</a></div>";return closeLightbox(),$("#lightbox").addClass(e).html(a),$("body").addClass("dimmed"),t.callback&&window[t.callback](),$("#lightbox").find('input[type="text"]').length>0&&$("#lightbox").find('input[type="text"]').eq(0).select(),$("#lightbox").find("textarea").length>0&&$("#lightbox").find("textarea").focus(),!1}function closeLightbox(){return $("#lightbox").hasClass("settings")&&discardSettings(),$("body").removeClass("dimmed"),$("#lightbox").empty(),$("#lightbox").removeClass(),!1}function selectUnitMeasure(){return window[$(this).closest("ul").attr("class")]=$(this).text().toLowerCase(),$(this).parent().addClass("active").siblings().removeClass("active"),"unit"==$(this).closest("ul").attr("class")&&drawRuler(),!1}function toggleUnit(){return unit="%"==unit?"px":"%",$(".unit").find("li").toggleClass("active"),drawRuler(),setCoords(),!1}function bindKeys(e){var t=$("body").hasClass("dimmed"),a=!t&&$(".map.selected").length>0;if(shortcut)switch(e.which){case 13:if(t&&0==$("#lightbox").find("textarea").length)return $("#btn-lb-yes").trigger("click"),!1;a&&openLightbox("link");break;case 27:t&&closeLightbox(),1==phase&&resetGrid();break;case 46:a&&openLightbox("remove");break;case 67:e.ctrlKey&&a&&duplicateMap("copy");break;case 86:e.ctrlKey&&!t&&duplicateMap("paste");break;case 85:t||toggleUnit();break;case 112:return openLightbox("shortcut"),!1}}function loadOptions(){getOption("popup")||setOption("popup",!0),getOption("shortcut")||setOption("shortcut",!0),getOption("theme")||setOption("theme","denim"),getOption("language")||setOption("language","eng"),resetOptions()}function resetOptions(){popup="true"==getOption("popup"),shortcut="true"==getOption("shortcut"),theme=getOption("theme"),langPreview||(language=getOption("language")),$("body").removeClass("denim wine green white batsy black").addClass(theme),langSelect()}function settingsCallback(){resetOptions(),$("#settings-edit-popup").prop("checked",popup),$("#settings-key-shortcuts").prop("checked",shortcut),$("#select-theme").find('option[value="'+theme+'"]').prop("selected",!0),$("#select-lang").find('option[value="'+language+'"]').prop("selected",!0),langPreview=!1}function popupPreview(){popup=$("#settings-edit-popup").prop("checked")}function shortcutPreview(){shortcut=$("#settings-key-shortcuts").prop("checked")}function themePreview(){theme=$(this).find("option:selected").val(),$("body").removeClass("denim wine green white batsy black").addClass(theme)}function languagePreview(){language=$(this).find("option:selected").val(),langSelect(),langPreview=!0,openLightbox("settings")}function discardSettings(){langPreview||resetOptions()}function applySettings(){return setOption("popup",popup),setOption("shortcut",shortcut),setOption("theme",theme),setOption("language",language),closeLightbox(),!1}function setOption(e,t){localStorage.setItem(e,t)}function getOption(e){return localStorage.getItem(e)}function langSelect(e){if("string"==typeof e)var t=window[e+"_navScript"];else t=window[language+"_navScript"];$(".script").each(function(){var e=$(this).data("script");$(this).text(t[e])})}$(document).on("click",".btn-lb-open",openLightbox).on("click",".btn-lb-close",closeLightbox).on("click",".btn-lb-load",loadImage).on("click",".btn-lb-clear",clearWorkspace).on("click",".btn-lb-link",linkMap).on("click",".btn-select",selectUnitMeasure).on("click","#btn-toggle-unit",toggleUnit).on("click",".btn-lb-removemap",removeMap).on("click",".btn-clipboard",copyCode).on("click",".btn-lb-import",importCode).on("click","#settings",function(){return openLightbox("settings"),!1}).on("click",".btn-lb-settings",applySettings).on("dblclick",".map",function(){return openLightbox("link"),!1}).on("resizestop dragstop",".map",editMap).on("mouseenter mouseleave","#imgwrap",toggleGrid).on("mousemove","#imgwrap",moveGrid).on("mousedown",".map",selectMap).on("mousedown mouseup click","#imgwrap",drawMap).on("change","#input-img-local",parsePath).on("change","#settings-edit-popup",popupPreview).on("change","#settings-key-shortcuts",shortcutPreview).on("change","#select-theme",themePreview).on("change","#select-lang",languagePreview).on("keydown",bindKeys),$(window).on("load",setup);